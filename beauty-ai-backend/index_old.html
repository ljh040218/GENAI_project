<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K-Beauty AI Backend API Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 2rem;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h2 {
      color: #ff69b4;
      margin-bottom: 1.5rem;
    }

    .section {
      border: 1px solid #ddd;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      background-color: #fff;
    }

    .section.profile {
      background-color: #fff5f7;
    }

    .section.analysis {
      background-color: #f0f8ff;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    input, select {
      margin-right: 0.5rem;
      padding: 0.6rem;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    select {
      width: 100%;
      background-color: white;
    }

    button {
      margin-left: 0.5rem;
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.primary {
      background-color: #ff69b4;
      color: white;
      border: none;
      font-weight: bold;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 14px;
    }

    .required {
      color: red;
    }

    .token-display {
      margin-top: 1rem;
      word-break: break-all;
      font-size: 0.85rem;
    }

    .token-display.valid {
      color: green;
    }

    .token-display.invalid {
      color: red;
    }

    .image-preview {
      margin-bottom: 1.5rem;
    }

    .image-preview img {
      max-width: 400px;
      max-height: 400px;
      display: block;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
    }

    .result-box {
      background: #f2f2f2;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }

    .category-result {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background-color: #fff;
      border-radius: 12px;
      border: 2px solid #f0f0f0;
    }

    .color-info {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background-color: #f9f9f9;
      border-radius: 8px;
    }

    .color-display {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .color-box {
      width: 80px;
      height: 80px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }

    .color-details {
      font-size: 0.9rem;
    }

    .color-details p {
      margin-bottom: 0.3rem;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .product-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .product-card:hover {
      transform: translateY(-4px);
    }

    .product-image-wrapper {
      position: relative;
    }

    .product-rank {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: #ff69b4;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .product-image-placeholder {
      width: 100%;
      height: 200px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }

    .product-info {
      padding: 1rem;
    }

    .product-color-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .product-color-circle {
      width: 30px;
      height: 30px;
      border: 2px solid #ddd;
      border-radius: 50%;
    }

    .product-delta {
      font-size: 0.85rem;
      color: #666;
    }

    .product-brand {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      color: #333;
      font-weight: bold;
    }

    .product-name {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: #666;
      line-height: 1.4;
    }

    .product-price {
      font-size: 1rem;
      font-weight: bold;
      color: #ff69b4;
    }

    .explanation-box {
      padding: 1.5rem;
      background-color: #fffbf5;
      border-radius: 8px;
      border: 1px solid #ffe4cc;
    }

    .explanation-box h4 {
      margin-bottom: 1rem;
      color: #ff8c00;
    }

    .explanation-box p {
      line-height: 1.8;
      white-space: pre-line;
      font-size: 0.95rem;
    }

    .price-range {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .price-range input {
      width: 200px;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .file-selected {
      margin-left: 1rem;
      color: green;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>K-Beauty AI Backend API Test</h2>

    <div class="section">
      <h3>1. 인증 (Authentication)</h3>
      <div class="input-group">
        <input type="text" id="username" value="testuser" placeholder="Username">
        <input type="email" id="email" value="test@example.com" placeholder="Email">
        <input type="password" id="password" value="Password123!" placeholder="Password">
      </div>
      <div>
        <button onclick="handleRegister()">회원가입</button>
        <button class="primary" onclick="handleLogin()">로그인</button>
        <button onclick="handleProfile()">내 프로필</button>
      </div>
      <div class="token-display">
        <p><b>Access Token:</b> <span id="tokenDisplay" class="invalid">(없음 - 로그인 필요)</span></p>
      </div>
    </div>

    <div class="section profile">
      <h3>2. 뷰티 프로필 (Beauty Profile)</h3>
      
      <div class="grid-2">
        <div class="form-group">
          <label><b>퍼스널 컬러 (Personal Color)</b> <span class="required">*</span></label>
          <select id="personalColor">
            <optgroup label="Spring (봄 웜톤)">
              <option value="bright_spring">Bright Spring (브라이트 봄)</option>
              <option value="true_spring">True Spring (트루 봄)</option>
              <option value="light_spring">Light Spring (라이트 봄)</option>
            </optgroup>
            <optgroup label="Summer (여름 쿨톤)">
              <option value="light_summer">Light Summer (라이트 여름)</option>
              <option value="true_summer">True Summer (트루 여름)</option>
              <option value="soft_summer">Soft Summer (소프트 여름)</option>
            </optgroup>
            <optgroup label="Autumn (가을 웜톤)">
              <option value="soft_autumn">Soft Autumn (소프트 가을)</option>
              <option value="true_autumn">True Autumn (트루 가을)</option>
              <option value="deep_autumn">Deep Autumn (딥 가을)</option>
            </optgroup>
            <optgroup label="Winter (겨울 쿨톤)">
              <option value="deep_winter">Deep Winter (딥 겨울)</option>
              <option value="true_winter">True Winter (트루 겨울)</option>
              <option value="bright_winter">Bright Winter (브라이트 겨울)</option>
            </optgroup>
          </select>
        </div>

        <div class="form-group">
          <label><b>피부 언더톤 (Skin Undertone)</b> <span class="required">*</span></label>
          <select id="skinUndertone">
            <option value="warm">Warm (웜톤)</option>
            <option value="cool">Cool (쿨톤)</option>
            <option value="neutral">Neutral (중성톤)</option>
          </select>
        </div>

        <div class="form-group">
          <label><b>피부 타입 (Skin Type)</b> <span class="required">*</span></label>
          <select id="skinType">
            <option value="oily">Oily (지성)</option>
            <option value="dry">Dry (건성)</option>
            <option value="combination" selected>Combination (복합성)</option>
            <option value="sensitive">Sensitive (민감성)</option>
          </select>
        </div>

        <div class="form-group">
          <label><b>명암 대비 (Contrast Level)</b> <span class="required">*</span></label>
          <select id="contrastLevel">
            <option value="high">High (높음)</option>
            <option value="medium" selected>Medium (중간)</option>
            <option value="low">Low (낮음)</option>
          </select>
        </div>

        <div class="form-group">
          <label><b>선호 피니시 (Preferred Finish)</b> <span class="required">*</span></label>
          <select id="preferredFinish">
            <option value="matte">Matte (매트)</option>
            <option value="glossy">Glossy (글로시)</option>
            <option value="satin">Satin (새틴)</option>
            <option value="velvet">Velvet (벨벳)</option>
            <option value="dewy" selected>Dewy (촉촉)</option>
          </select>
        </div>

        <div class="form-group">
          <label><b>선호 매장 (Preferred Store)</b> <span class="required">*</span></label>
          <select id="preferredStore">
            <option value="roadshop" selected>Roadshop (로드샵)</option>
            <option value="department">Department (백화점)</option>
            <option value="online">Online (온라인)</option>
            <option value="luxury">Luxury (럭셔리)</option>
          </select>
        </div>

        <div class="form-group full-width">
          <label><b>가격대 (Price Range)</b></label>
          <div class="price-range">
            <input type="number" id="priceRangeMin" value="10000" placeholder="최소 금액">
            <span>~</span>
            <input type="number" id="priceRangeMax" value="30000" placeholder="최대 금액">
            <span>원</span>
          </div>
        </div>
      </div>

      <div style="margin-top: 1.5rem;">
        <button class="primary" onclick="handleCreateBeautyProfile()">뷰티 프로필 생성</button>
        <button onclick="handleGetBeautyProfile()">프로필 조회</button>
        <button onclick="handleUpdateBeautyProfile()">프로필 업데이트</button>
      </div>
    </div>

    <div class="section analysis">
      <h3>3. 이미지 분석 & 제품 추천</h3>
      <div class="form-group">
        <label><b>메이크업 이미지 업로드</b></label>
        <input type="file" id="imageFile" accept="image/*" onchange="handleImageChange()" style="width: 300px;">
        <span id="fileSelected" class="file-selected" style="display: none;"></span>
      </div>

      <div id="imagePreview" class="image-preview" style="display: none;">
        <label><b>이미지 미리보기</b></label>
        <img id="previewImage" alt="Preview">
      </div>

      <button class="primary" onclick="handleAnalyzeImage()" id="analyzeBtn">이미지 분석 & 추천 받기</button>

      <div id="analysisResults" style="margin-top: 1.5rem;"></div>
    </div>

    <div class="section">
      <h3>API 응답 결과</h3>
      <pre id="apiResult" class="result-box">결과가 여기에 표시됩니다.</pre>
    </div>
  </div>

  <script>
    const NODE_API = "https://genaiproject-production.up.railway.app/api";
    const PYTHON_API = "https://pythonapi-production-8efe.up.railway.app";

    let token = "";
    let imageFile = null;

    function labToRGB(L, a, b) {
      let y = (L + 16) / 116;
      let x = a / 500 + y;
      let z = y - b / 200;

      x = 0.95047 * ((x * x * x > 0.008856) ? x * x * x : (x - 16/116) / 7.787);
      y = 1.00000 * ((y * y * y > 0.008856) ? y * y * y : (y - 16/116) / 7.787);
      z = 1.08883 * ((z * z * z > 0.008856) ? z * z * z : (z - 16/116) / 7.787);

      let r = x *  3.2406 + y * -1.5372 + z * -0.4986;
      let g = x * -0.9689 + y *  1.8758 + z *  0.0415;
      let bl = x *  0.0557 + y * -0.2040 + z *  1.0570;

      r = (r > 0.0031308) ? (1.055 * Math.pow(r, 1/2.4) - 0.055) : 12.92 * r;
      g = (g > 0.0031308) ? (1.055 * Math.pow(g, 1/2.4) - 0.055) : 12.92 * g;
      bl = (bl > 0.0031308) ? (1.055 * Math.pow(bl, 1/2.4) - 0.055) : 12.92 * bl;

      const red = Math.max(0, Math.min(255, Math.round(r * 255)));
      const green = Math.max(0, Math.min(255, Math.round(g * 255)));
      const blue = Math.max(0, Math.min(255, Math.round(bl * 255)));

      return `rgb(${red}, ${green}, ${blue})`;
    }

    function updateTokenDisplay() {
      const display = document.getElementById('tokenDisplay');
      if (token) {
        display.textContent = token;
        display.className = 'valid';
      } else {
        display.textContent = '(없음 - 로그인 필요)';
        display.className = 'invalid';
      }
    }

    function updateResult(data) {
      document.getElementById('apiResult').textContent = JSON.stringify(data, null, 2);
    }

    async function handleRegister() {
      const username = document.getElementById('username').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(`${NODE_API}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email, password })
        });

        const data = await res.json();
        updateResult(data);

        if (res.ok) {
          alert("회원가입 성공!");
        } else {
          alert(`회원가입 실패: ${data.message}`);
        }
      } catch (err) {
        console.error(err);
        alert("회원가입 실패");
        updateResult({ success: false, message: "Network error" });
      }
    }

    async function handleLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(`${NODE_API}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        updateResult(data);

        if (data?.accessToken) {
          token = data.accessToken;
          updateTokenDisplay();
          alert("로그인 성공!");
        } else {
          alert("로그인 실패");
        }
      } catch (err) {
        console.error(err);
        alert("로그인 실패");
        updateResult({ success: false, message: "Network error" });
      }
    }

    async function handleProfile() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      try {
        const res = await fetch(`${NODE_API}/auth/profile`, {
          method: "GET",
          headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await res.json();
        updateResult(data);
      } catch (err) {
        console.error(err);
        updateResult({ success: false, message: "Network error" });
      }
    }

    async function handleCreateBeautyProfile() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      const profileData = {
        personalColor: document.getElementById('personalColor').value,
        skinUndertone: document.getElementById('skinUndertone').value,
        skinType: document.getElementById('skinType').value,
        contrastLevel: document.getElementById('contrastLevel').value,
        preferredFinish: document.getElementById('preferredFinish').value,
        preferredStore: document.getElementById('preferredStore').value,
        priceRangeMin: parseInt(document.getElementById('priceRangeMin').value),
        priceRangeMax: parseInt(document.getElementById('priceRangeMax').value)
      };

      try {
        const res = await fetch(`${NODE_API}/profile/beauty`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(profileData)
        });

        const data = await res.json();
        updateResult(data);

        if (res.ok) {
          alert("뷰티 프로필 생성 성공!");
        } else {
          alert(`프로필 생성 실패: ${data.message}`);
        }
      } catch (err) {
        console.error(err);
        alert("프로필 생성 실패");
        updateResult({ success: false, message: "Network error" });
      }
    }

    async function handleGetBeautyProfile() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      try {
        const res = await fetch(`${NODE_API}/profile/beauty`, {
          method: "GET",
          headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await res.json();
        updateResult(data);
      } catch (err) {
        console.error(err);
        updateResult({ success: false, message: "Network error" });
      }
    }

    async function handleUpdateBeautyProfile() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      const profileData = {
        personalColor: document.getElementById('personalColor').value,
        skinUndertone: document.getElementById('skinUndertone').value,
        skinType: document.getElementById('skinType').value,
        contrastLevel: document.getElementById('contrastLevel').value,
        preferredFinish: document.getElementById('preferredFinish').value,
        preferredStore: document.getElementById('preferredStore').value,
        priceRangeMin: parseInt(document.getElementById('priceRangeMin').value),
        priceRangeMax: parseInt(document.getElementById('priceRangeMax').value)
      };

      try {
        const res = await fetch(`${NODE_API}/profile/beauty`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(profileData)
        });

        const data = await res.json();
        updateResult(data);

        if (res.ok) {
          alert("뷰티 프로필 업데이트 성공!");
        } else {
          alert(`프로필 업데이트 실패: ${data.message}`);
        }
      } catch (err) {
        console.error(err);
        alert("프로필 업데이트 실패");
        updateResult({ success: false, message: "Network error" });
      }
    }

    function handleImageChange() {
      const input = document.getElementById('imageFile');
      const file = input.files[0];
      
      if (!file) return;
      
      imageFile = file;
      document.getElementById('fileSelected').textContent = `선택된 파일: ${file.name}`;
      document.getElementById('fileSelected').style.display = 'inline';

      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('previewImage').src = e.target.result;
        document.getElementById('imagePreview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    async function handleAnalyzeImage() {
      if (!token) {
        alert("먼저 로그인하세요!");
        return;
      }

      if (!imageFile) {
        alert("이미지를 업로드하세요.");
        return;
      }

      const btn = document.getElementById('analyzeBtn');
      btn.textContent = "분석 중...";
      btn.disabled = true;

      try {
        const formData = new FormData();
        formData.append("file", imageFile);

        const res = await fetch(`${PYTHON_API}/api/analyze/image`, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          renderAnalysisResults(data);
          alert("이미지 분석 완료!");
        } else {
          alert(`이미지 분석 실패: ${data.detail || data.message}`);
          document.getElementById('analysisResults').innerHTML = 
            `<div style="padding: 1rem; background-color: #fee; border-radius: 8px; color: #c00;">
              <h4>오류 발생</h4>
              <pre class="result-box">${JSON.stringify(data, null, 2)}</pre>
            </div>`;
        }
      } catch (err) {
        console.error(err);
        alert("이미지 분석 중 오류 발생");
      } finally {
        btn.textContent = "이미지 분석 & 추천 받기";
        btn.disabled = false;
      }
    }

    function renderAnalysisResults(data) {
      if (!data.success) return;

      const categoryNames = {
        lips: '립',
        cheeks: '치크',
        eyeshadow: '아이섀도우'
      };

      let html = '<h4>분석 결과</h4>';

      ['lips', 'cheeks', 'eyeshadow'].forEach(category => {
        const categoryData = data[category];
        if (!categoryData) return;

        html += `
          <div class="category-result">
            <h3 style="color: #ff69b4; margin-bottom: 1rem;">${categoryNames[category]} 추천 제품</h3>

            <div class="color-info">
              <h4 style="margin-bottom: 0.5rem;">추출된 색상 정보</h4>
              <div class="color-display">
                <div class="color-box" style="background-color: ${labToRGB(
                  categoryData.color.lab_standard[0],
                  categoryData.color.lab_standard[1],
                  categoryData.color.lab_standard[2]
                )}"></div>
                <div class="color-details">
                  <p><b>LAB (Standard):</b> L=${categoryData.color.lab_standard[0].toFixed(1)}, a=${categoryData.color.lab_standard[1].toFixed(1)}, b=${categoryData.color.lab_standard[2].toFixed(1)}</p>
                  <p><b>Tone Group:</b> ${categoryData.color.tone_group}</p>
                  <p><b>Hue:</b> ${categoryData.color.hue.toFixed(2)}°</p>
                  <p><b>Chroma:</b> ${categoryData.color.chroma.toFixed(2)}</p>
                </div>
              </div>
            </div>

            <div class="products-grid">
              ${categoryData.recommendations.map((product, idx) => `
                <div class="product-card">
                  <div class="product-image-wrapper">
                    <div class="product-rank">${idx + 1}위</div>
                    <img 
                      src="${product.image_url}" 
                      alt="${product.name}"
                      class="product-image"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    >
                    <div class="product-image-placeholder" style="display: none;">
                      이미지 없음
                    </div>
                  </div>
                  
                  <div class="product-info">
                    <div class="product-color-info">
                      <div class="product-color-circle" style="background-color: ${product.color_hex}"></div>
                      <span class="product-delta">ΔE: ${product.deltaE.toFixed(2)}</span>
                    </div>
                    
                    <h4 class="product-brand">${product.brand}</h4>
                    <p class="product-name">${product.name}</p>
                    <p class="product-price">${product.price.toLocaleString()}원</p>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="explanation-box">
              <h4>추천 이유</h4>
              <p>${categoryData.explanation}</p>
            </div>
          </div>
        `;
      });

      document.getElementById('analysisResults').innerHTML = html;
    }
  </script>
</body>
</html>
