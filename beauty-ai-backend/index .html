<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K-Beauty AI Test</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5;
      padding: 2rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 2rem;
      color: #333;
    }

    .section {
      border: 1px solid #ddd;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      background-color: #fff;
    }

    h2, h3 {
      margin-bottom: 1rem;
      color: #333;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 14px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="file"],
    select {
      width: 100%;
      padding: 0.6rem;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 14px;
      background-color: white;
    }

    .inline-inputs {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .inline-inputs input {
      flex: 1;
    }

    button {
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #f0f0f0;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .primary-button {
      background-color: #ff69b4;
      color: white;
      border: none;
      font-weight: bold;
    }

    .primary-button:hover {
      background-color: #ff1493;
    }

    pre {
      background: #f2f2f2;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .image-preview {
      width: 100%;
      max-width: 600px;
      margin: 1rem 0;
      border-radius: 8px;
      border: 2px solid #ddd;
    }

    .category-result {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background-color: #fff;
      border-radius: 12px;
      border: 2px solid #f0f0f0;
    }

    .color-info {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background-color: #f9f9f9;
      border-radius: 8px;
    }

    .color-display {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .color-box {
      width: 80px;
      height: 80px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }

    .color-details {
      font-size: 0.9rem;
    }

    .color-details p {
      margin-bottom: 0.3rem;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .product-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .product-image-container {
      position: relative;
    }

    .rank-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: #ff69b4;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px 8px 0 0;
    }

    .no-image {
      display: none;
      width: 100%;
      height: 200px;
      background-color: #f0f0f0;
      align-items: center;
      justify-content: center;
      border-radius: 8px 8px 0 0;
      color: #999;
    }

    .product-content {
      padding: 1rem;
    }

    .product-color-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .product-color-circle {
      width: 30px;
      height: 30px;
      border: 2px solid #ddd;
      border-radius: 50%;
    }

    .delta-e {
      font-size: 0.85rem;
      color: #666;
    }

    .product-brand {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      color: #333;
      font-weight: 500;
    }

    .product-name {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: #666;
      line-height: 1.4;
    }

    .product-price {
      font-size: 1rem;
      font-weight: bold;
      color: #ff69b4;
    }

    .explanation-box {
      padding: 1.5rem;
      background-color: #fffbf5;
      border-radius: 8px;
      border: 1px solid #ffe4cc;
    }

    .explanation-box h4 {
      margin-bottom: 1rem;
      color: #ff8c00;
    }

    .explanation-box p {
      line-height: 1.8;
      white-space: pre-line;
      font-size: 0.95rem;
    }

    .error-box {
      padding: 1rem;
      background-color: #fee;
      border-radius: 8px;
      color: #c00;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      font-size: 1.1rem;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>K-Beauty AI Test Interface</h1>

    <div class="section">
      <h2>1. 회원가입</h2>
      <div class="input-group">
        <label>Username</label>
        <input type="text" id="username" value="testuser">
      </div>
      <div class="input-group">
        <label>Email</label>
        <input type="email" id="email" value="test@example.com">
      </div>
      <div class="input-group">
        <label>Password</label>
        <input type="password" id="password" value="Password123!">
      </div>
      <button onclick="handleRegister()" class="primary-button">회원가입</button>
    </div>

    <div class="section">
      <h2>2. 로그인</h2>
      <div class="input-group">
        <label>Email</label>
        <input type="email" id="loginEmail" value="test@example.com">
      </div>
      <div class="input-group">
        <label>Password</label>
        <input type="password" id="loginPassword" value="Password123!">
      </div>
      <button onclick="handleLogin()" class="primary-button">로그인</button>
      <div style="margin-top: 1rem;">
        <strong>Token:</strong> <span id="tokenDisplay">로그인 후 토큰이 여기에 표시됩니다</span>
      </div>
    </div>

    <div class="section">
      <h2>3. 프로필 조회</h2>
      <button onclick="handleProfile()">내 프로필 가져오기</button>
    </div>

    <div class="section">
      <h2>4. 뷰티 프로필 생성</h2>
      
      <div class="input-group">
        <label>퍼스널 컬러</label>
        <select id="personalColor">
          <optgroup label="Spring (봄 웜톤)">
            <option value="bright_spring">Bright Spring (브라이트 봄)</option>
            <option value="true_spring">True Spring (트루 봄)</option>
            <option value="light_spring">Light Spring (라이트 봄)</option>
          </optgroup>
          <optgroup label="Summer (여름 쿨톤)">
            <option value="light_summer">Light Summer (라이트 여름)</option>
            <option value="true_summer">True Summer (트루 여름)</option>
            <option value="soft_summer">Soft Summer (소프트 여름)</option>
          </optgroup>
          <optgroup label="Autumn (가을 웜톤)">
            <option value="soft_autumn">Soft Autumn (소프트 가을)</option>
            <option value="true_autumn">True Autumn (트루 가을)</option>
            <option value="deep_autumn">Deep Autumn (딥 가을)</option>
          </optgroup>
          <optgroup label="Winter (겨울 쿨톤)">
            <option value="deep_winter">Deep Winter (딥 겨울)</option>
            <option value="true_winter">True Winter (트루 겨울)</option>
            <option value="bright_winter">Bright Winter (브라이트 겨울)</option>
          </optgroup>
        </select>
      </div>

      <div class="input-group">
        <label>피부 언더톤</label>
        <select id="skinUndertone">
          <option value="warm">Warm</option>
          <option value="cool">Cool</option>
          <option value="neutral">Neutral</option>
        </select>
      </div>

      <div class="input-group">
        <label>선호하는 피니시</label>
        <select id="preferredFinish">
          <option value="">선택안함</option>
          <option value="matte">Matte</option>
          <option value="glossy">Glossy</option>
          <option value="satin">Satin</option>
          <option value="dewy">Dewy</option>
        </select>
      </div>

      <button onclick="handleCreateBeautyProfile()" class="primary-button">뷰티 프로필 생성</button>
    </div>

    <div class="section">
      <h2>5. 뷰티 프로필 조회</h2>
      <button onclick="handleGetBeautyProfile()">내 뷰티 프로필 가져오기</button>
    </div>

    <div class="section">
      <h2>6. 뷰티 프로필 업데이트</h2>
      <button onclick="handleUpdateBeautyProfile()">뷰티 프로필 업데이트 (위 입력값 사용)</button>
    </div>

    <div class="section">
      <h2>7. 이미지 분석 및 추천</h2>
      <div class="input-group">
        <label>메이크업 이미지 업로드</label>
        <input type="file" id="imageFile" accept="image/*" onchange="handleImageChange(event)">
      </div>
      <img id="imagePreview" class="image-preview" style="display: none;">
      <button onclick="handleImageAnalysis()" class="primary-button">이미지 분석 및 추천받기</button>
      
      <div id="analysisLoading" class="loading" style="display: none;">
        분석 중입니다. 잠시만 기다려주세요...
      </div>
      
      <div id="analysisResult" style="margin-top: 1rem;"></div>
    </div>

    <div class="section">
      <h3>API 응답 결과</h3>
      <pre id="apiResult">결과가 여기에 표시됩니다.</pre>
    </div>
  </div>

  <script>
    const NODE_API = "https://genaiproject-production.up.railway.app/api";
    const PYTHON_API = "https://pythonapi-production-8efe.up.railway.app";
    
    let token = "";
    let imageFile = null;

    function labToRGB(L, a, b) {
      let y = (L + 16) / 116;
      let x = a / 500 + y;
      let z = y - b / 200;

      x = 0.95047 * ((x * x * x > 0.008856) ? x * x * x : (x - 16/116) / 7.787);
      y = 1.00000 * ((y * y * y > 0.008856) ? y * y * y : (y - 16/116) / 7.787);
      z = 1.08883 * ((z * z * z > 0.008856) ? z * z * z : (z - 16/116) / 7.787);

      let r = x *  3.2406 + y * -1.5372 + z * -0.4986;
      let g = x * -0.9689 + y *  1.8758 + z *  0.0415;
      let bl = x *  0.0557 + y * -0.2040 + z *  1.0570;

      r = (r > 0.0031308) ? (1.055 * Math.pow(r, 1/2.4) - 0.055) : 12.92 * r;
      g = (g > 0.0031308) ? (1.055 * Math.pow(g, 1/2.4) - 0.055) : 12.92 * g;
      bl = (bl > 0.0031308) ? (1.055 * Math.pow(bl, 1/2.4) - 0.055) : 12.92 * bl;

      const red = Math.max(0, Math.min(255, Math.round(r * 255)));
      const green = Math.max(0, Math.min(255, Math.round(g * 255)));
      const blue = Math.max(0, Math.min(255, Math.round(bl * 255)));

      return `rgb(${red}, ${green}, ${blue})`;
    }

    function setResult(data) {
      document.getElementById('apiResult').textContent = JSON.stringify(data, null, 2);
    }

    async function handleRegister() {
      const username = document.getElementById('username').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(`${NODE_API}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email, password })
        });

        const data = await res.json();
        setResult(data);

        if (res.ok) {
          alert("회원가입 성공!");
        } else {
          alert(`회원가입 실패: ${data.message}`);
        }
      } catch (err) {
        console.error(err);
        alert("회원가입 실패");
        setResult({ success: false, message: "Network error" });
      }
    }

    async function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const res = await fetch(`${NODE_API}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        setResult(data);

        if (data?.accessToken) {
          token = data.accessToken;
          document.getElementById('tokenDisplay').textContent = token;
          alert("로그인 성공!");
        } else {
          alert("로그인 실패");
        }
      } catch (err) {
        console.error(err);
        alert("로그인 실패");
        setResult({ success: false, message: "Network error" });
      }
    }

    async function handleProfile() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      try {
        const res = await fetch(`${NODE_API}/auth/profile`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        const data = await res.json();
        setResult(data);
      } catch (err) {
        console.error(err);
        setResult({ success: false, message: "Network error" });
      }
    }

    async function handleCreateBeautyProfile() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      const personalColor = document.getElementById('personalColor').value;
      const skinUndertone = document.getElementById('skinUndertone').value;
      const preferredFinish = document.getElementById('preferredFinish').value;

      const profileData = {
        personalColor,
        skinUndertone
      };

      if (preferredFinish) profileData.preferredFinish = preferredFinish;

      try {
        const res = await fetch(`${NODE_API}/profile/beauty`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(profileData)
        });

        const data = await res.json();
        setResult(data);

        if (res.ok) {
          alert("뷰티 프로필 생성 성공!");
        } else {
          alert(`프로필 생성 실패: ${data.message}`);
        }
      } catch (err) {
        console.error(err);
        alert("프로필 생성 실패");
        setResult({ success: false, message: "Network error" });
      }
    }

    async function handleGetBeautyProfile() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      try {
        const res = await fetch(`${NODE_API}/profile/beauty`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        const data = await res.json();
        setResult(data);
      } catch (err) {
        console.error(err);
        setResult({ success: false, message: "Network error" });
      }
    }

    async function handleUpdateBeautyProfile() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      const personalColor = document.getElementById('personalColor').value;
      const skinUndertone = document.getElementById('skinUndertone').value;
      const preferredFinish = document.getElementById('preferredFinish').value;

      const profileData = {
        personalColor,
        skinUndertone
      };

      if (preferredFinish) profileData.preferredFinish = preferredFinish;

      try {
        const res = await fetch(`${NODE_API}/profile/beauty`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(profileData)
        });

        const data = await res.json();
        setResult(data);

        if (res.ok) {
          alert("뷰티 프로필 업데이트 성공!");
        } else {
          alert(`프로필 업데이트 실패: ${data.message}`);
        }
      } catch (err) {
        console.error(err);
        alert("프로필 업데이트 실패");
        setResult({ success: false, message: "Network error" });
      }
    }

    function handleImageChange(event) {
      const file = event.target.files[0];
      if (file) {
        imageFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('imagePreview');
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    async function handleImageAnalysis() {
      if (!token) {
        alert("로그인 먼저 진행하세요.");
        return;
      }

      if (!imageFile) {
        alert("이미지를 먼저 선택해주세요.");
        return;
      }

      const loadingDiv = document.getElementById('analysisLoading');
      const resultDiv = document.getElementById('analysisResult');
      loadingDiv.style.display = 'block';
      resultDiv.innerHTML = '';

      const formData = new FormData();
      formData.append('image', imageFile);

      try {
        const res = await fetch(`${PYTHON_API}/analyze`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await res.json();
        loadingDiv.style.display = 'none';

        if (data.success) {
          displayAnalysisResults(data);
        } else {
          resultDiv.innerHTML = `
            <div class="error-box">
              <h4>오류 발생</h4>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        }
        
        setResult(data);
      } catch (err) {
        console.error(err);
        loadingDiv.style.display = 'none';
        resultDiv.innerHTML = `
          <div class="error-box">
            <h4>오류 발생</h4>
            <p>${err.message}</p>
          </div>
        `;
        setResult({ success: false, message: "Network error" });
      }
    }

    function displayAnalysisResults(data) {
      const resultDiv = document.getElementById('analysisResult');
      const categoryNames = {
        'lipstick': '립스틱',
        'blush': '블러셔',
        'eyeshadow': '아이섀도우'
      };

      let html = '';

      for (const category in data.results) {
        const categoryData = data.results[category];
        
        html += `
          <div class="category-result">
            <h3>${categoryNames[category]} 추천 제품</h3>
            
            <div class="color-info">
              <h4 style="margin-bottom: 0.5rem;">추출된 색상 정보</h4>
              <div class="color-display">
                <div class="color-box" style="background-color: ${labToRGB(
                  categoryData.color.lab_standard[0],
                  categoryData.color.lab_standard[1],
                  categoryData.color.lab_standard[2]
                )}"></div>
                <div class="color-details">
                  <p><b>LAB (Standard):</b> L=${categoryData.color.lab_standard[0].toFixed(1)}, a=${categoryData.color.lab_standard[1].toFixed(1)}, b=${categoryData.color.lab_standard[2].toFixed(1)}</p>
                  <p><b>Tone Group:</b> ${categoryData.color.tone_group}</p>
                  <p><b>Hue:</b> ${categoryData.color.hue.toFixed(2)}°</p>
                  <p><b>Chroma:</b> ${categoryData.color.chroma.toFixed(2)}</p>
                </div>
              </div>
            </div>

            <div class="products-grid">
        `;

        categoryData.recommendations.forEach((product, idx) => {
          html += `
            <div class="product-card">
              <div class="product-image-container">
                <div class="rank-badge">${idx + 1}위</div>
                <img 
                  class="product-image" 
                  src="${product.image_url}" 
                  alt="${product.name}"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                >
                <div class="no-image">이미지 없음</div>
              </div>
              
              <div class="product-content">
                <div class="product-color-info">
                  <div class="product-color-circle" style="background-color: ${product.color_hex}"></div>
                  <span class="delta-e">ΔE: ${product.deltaE.toFixed(2)}</span>
                </div>
                
                <h4 class="product-brand">${product.brand}</h4>
                <p class="product-name">${product.name}</p>
                <p class="product-price">${product.price.toLocaleString()}원</p>
              </div>
            </div>
          `;
        });

        html += `
            </div>

            <div class="explanation-box">
              <h4>추천 이유</h4>
              <p>${categoryData.explanation}</p>
            </div>
          </div>
        `;
      }

      resultDiv.innerHTML = html;
    }
  </script>
</body>
</html>